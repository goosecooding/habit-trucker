<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RITUAL</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0a0a0f;--surface:#111118;--surface2:#1a1a24;--border:#ffffff0f;--text:#f0eff5;--muted:#6b6a7a;--accent:#c8fa64;--accent2:#7c6aff;--accent3:#ff6a6a;--glow:#c8fa6433;--nav-h:72px}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:9000;opacity:.5}
.orb{position:fixed;border-radius:50%;filter:blur(120px);pointer-events:none;z-index:0;animation:orbFloat 8s ease-in-out infinite}
.orb-1{width:500px;height:500px;background:#7c6aff15;top:-100px;right:-100px}
.orb-2{width:400px;height:400px;background:#c8fa6410;bottom:100px;left:-80px;animation-delay:-4s}
@keyframes orbFloat{0%,100%{transform:translate(0,0) scale(1)}50%{transform:translate(20px,-30px) scale(1.05)}}

/* pages */
.page{display:none;position:relative;z-index:1;max-width:860px;margin:0 auto;padding:40px 24px calc(var(--nav-h) + 24px);animation:pageIn .35s cubic-bezier(.16,1,.3,1) both}
.page.active{display:block}
@keyframes pageIn{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* header */
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:36px}
.logo{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;letter-spacing:.12em;line-height:1}
.logo span{color:var(--accent)}
.date-badge{font-family:'DM Mono',monospace;font-size:.75rem;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;background:var(--surface);border:1px solid var(--border);padding:8px 14px;border-radius:100px}

/* stats */
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:32px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:18px 20px;position:relative;overflow:hidden;transition:transform .3s ease,border-color .3s ease}
.stat-card:hover{transform:translateY(-3px);border-color:#ffffff1a}
.stat-card::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,#ffffff05 0%,transparent 60%);pointer-events:none}
.stat-label{font-size:.7rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
.stat-value{font-family:'Bebas Neue',sans-serif;font-size:2.6rem;line-height:1}
.stat-value.accent{color:var(--accent)}.stat-value.accent2{color:var(--accent2)}
.stat-icon{position:absolute;top:16px;right:16px;font-size:1.3rem;opacity:.35}

/* section */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.section-title{font-family:'Bebas Neue',sans-serif;font-size:1.15rem;letter-spacing:.12em;color:var(--muted)}

/* add form */
.add-form{display:flex;gap:10px;margin-bottom:28px}
.habit-input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:13px 16px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.93rem;outline:none;transition:border-color .25s ease,box-shadow .25s ease}
.habit-input::placeholder{color:var(--muted)}
.habit-input:focus{border-color:var(--accent2);box-shadow:0 0 0 3px #7c6aff20}
.emoji-select{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:13px;color:var(--text);font-size:1.2rem;outline:none;cursor:pointer;width:52px;text-align:center;transition:border-color .25s,transform .2s}
.emoji-select:hover{transform:scale(1.1);border-color:#ffffff20}
.add-btn{background:var(--accent);color:#0a0a0f;border:none;border-radius:14px;padding:13px 20px;font-family:'DM Sans',sans-serif;font-size:.88rem;font-weight:600;cursor:pointer;letter-spacing:.03em;transition:transform .2s ease,box-shadow .2s ease;white-space:nowrap}
.add-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px var(--glow)}
.add-btn:active{transform:scale(.97)}

/* habit cards */
.habits-list{display:flex;flex-direction:column;gap:12px}
.habit-card{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:15px 16px;display:flex;align-items:flex-start;gap:12px;position:relative;overflow:hidden;transition:transform .3s ease,border-color .3s ease,box-shadow .3s ease;animation:cardIn .45s cubic-bezier(.16,1,.3,1) both}
.habit-card:hover{transform:translateY(-2px);border-color:#ffffff15;box-shadow:0 8px 28px #00000040}
.habit-card.completed{border-color:#c8fa6420;background:linear-gradient(135deg,#111118 0%,#12180f 100%)}
.habit-card.completed::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--accent);border-radius:0 4px 4px 0}
@keyframes cardIn{from{opacity:0;transform:translateX(-16px)}to{opacity:1;transform:translateX(0)}}

.check-btn{width:40px;height:40px;border-radius:12px;border:2px solid var(--border);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:all .3s cubic-bezier(.34,1.56,.64,1);flex-shrink:0;position:relative;overflow:hidden;margin-top:2px}
.check-btn::before{content:'';position:absolute;inset:0;background:var(--accent);transform:scale(0);border-radius:inherit;transition:transform .3s cubic-bezier(.34,1.56,.64,1)}
.check-btn.done::before{transform:scale(1)}
.check-btn:hover{border-color:var(--accent);transform:scale(1.08)}
.check-btn .checkmark{position:relative;z-index:1;opacity:0;transition:opacity .2s,transform .3s;transform:scale(.5) rotate(-10deg)}
.check-btn.done .checkmark{opacity:1;transform:scale(1) rotate(0)}

.habit-emoji{font-size:1.5rem;width:34px;text-align:center;flex-shrink:0;transition:transform .3s;margin-top:4px}
.habit-card:hover .habit-emoji{transform:scale(1.15) rotate(-5deg)}
.habit-info{flex:1;min-width:0}
.habit-name{font-size:.95rem;font-weight:500;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.habit-card.completed .habit-name{color:var(--accent)}
.habit-meta{display:flex;align-items:center;gap:10px}
.streak-badge{display:flex;align-items:center;gap:4px;font-family:'DM Mono',monospace;font-size:.7rem;color:var(--muted);letter-spacing:.04em}
.streak-badge.hot{color:#ff9f43}
.streak-flame{font-size:.78rem;animation:flicker 1.5s ease-in-out infinite}
@keyframes flicker{0%,100%{transform:scale(1) rotate(-2deg)}50%{transform:scale(1.15) rotate(2deg)}}
.week-dots{display:flex;gap:3px}
.dot{width:7px;height:7px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);transition:background .3s}
.dot.filled{background:var(--accent);border-color:var(--accent)}

/* daily task */
.habit-task{margin-top:8px;font-size:.8rem;color:var(--muted);background:var(--surface2);border-left:2px solid var(--accent2);border-radius:0 8px 8px 0;padding:6px 10px;line-height:1.4;animation:taskIn .3s ease both}
@keyframes taskIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}

/* card actions */
.card-actions{display:flex;flex-direction:column;gap:4px;opacity:0;transition:opacity .2s;flex-shrink:0}
.habit-card:hover .card-actions{opacity:1}
.icon-btn{background:none;border:none;cursor:pointer;padding:5px 7px;border-radius:8px;font-size:.85rem;transition:color .2s,background .2s,transform .2s;line-height:1;color:var(--muted)}
.icon-btn:hover{transform:scale(1.15)}
.icon-btn.delete:hover{color:var(--accent3);background:#ff6a6a15}
.icon-btn.task-btn:hover{color:var(--accent2);background:#7c6aff15}

/* heatmap */
.heatmap-section{margin-top:32px}
.heatmap-wrapper{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:20px;overflow-x:auto}
.heatmap-grid{display:flex;gap:4px;min-width:max-content}
.heatmap-col{display:flex;flex-direction:column;gap:4px}
.heatmap-cell{width:13px;height:13px;border-radius:3px;background:var(--surface2);transition:transform .2s;cursor:pointer}
.heatmap-cell:hover{transform:scale(1.5);z-index:10;position:relative}
.heatmap-cell[data-level="1"]{background:#c8fa6430}
.heatmap-cell[data-level="2"]{background:#c8fa6460}
.heatmap-cell[data-level="3"]{background:#c8fa6490}
.heatmap-cell[data-level="4"]{background:#c8fa64cc}
.heatmap-cell[data-level="5"]{background:#c8fa64}
.month-labels{display:flex;gap:4px;margin-bottom:5px;min-width:max-content}
.month-label{font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;width:13px}

/* empty */
.empty-state{text-align:center;padding:48px 24px;color:var(--muted);font-size:.88rem}
.empty-state .icon{font-size:3rem;margin-bottom:12px;display:block;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1);opacity:.6}50%{transform:scale(1.1);opacity:1}}

/* bottom nav */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;height:var(--nav-h);background:#0e0e16ee;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:center;gap:8px;z-index:500;padding:0 20px}
.nav-btn{display:flex;flex-direction:column;align-items:center;gap:4px;background:none;border:none;cursor:pointer;padding:10px 36px;border-radius:16px;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:.7rem;font-weight:500;letter-spacing:.06em;text-transform:uppercase;transition:color .25s,background .25s;position:relative}
.nav-btn .nav-icon{font-size:1.35rem;transition:transform .3s cubic-bezier(.34,1.56,.64,1)}
.nav-btn:hover{color:var(--text)}
.nav-btn:hover .nav-icon{transform:translateY(-3px) scale(1.1)}
.nav-btn.active{color:var(--accent);background:#c8fa6410}
.nav-btn.active .nav-icon{transform:translateY(-3px) scale(1.12)}
.nav-btn.active::after{content:'';position:absolute;bottom:-1px;left:50%;transform:translateX(-50%);width:24px;height:2px;background:var(--accent);border-radius:2px 2px 0 0}

/* recap */
.recap-compose{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:20px;margin-bottom:28px}
.recap-compose-title{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:.1em;color:var(--muted);margin-bottom:12px}
.recap-textarea{width:100%;min-height:110px;resize:vertical;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.91rem;outline:none;line-height:1.55;transition:border-color .25s,box-shadow .25s;margin-bottom:12px}
.recap-textarea::placeholder{color:var(--muted)}
.recap-textarea:focus{border-color:var(--accent2);box-shadow:0 0 0 3px #7c6aff20}
.recap-compose-footer{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.mood-row{display:flex;gap:6px}
.mood-btn{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:6px 10px;font-size:1.1rem;cursor:pointer;transition:transform .2s,border-color .2s,background .2s}
.mood-btn:hover{transform:scale(1.2)}
.mood-btn.selected{background:#c8fa6420;border-color:var(--accent);transform:scale(1.15)}
.recap-entries{display:flex;flex-direction:column;gap:16px}
.recap-entry{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:18px 20px;position:relative;animation:cardIn .4s cubic-bezier(.16,1,.3,1) both;transition:border-color .3s}
.recap-entry:hover{border-color:#ffffff12}
.recap-entry-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.recap-entry-date{font-family:'DM Mono',monospace;font-size:.7rem;color:var(--accent2);letter-spacing:.08em;text-transform:uppercase}
.recap-entry-mood{font-size:1.2rem}
.recap-entry-text{font-size:.88rem;color:var(--text);line-height:1.6;white-space:pre-wrap;word-break:break-word}
.recap-delete-btn{position:absolute;top:14px;right:14px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:.85rem;padding:4px 6px;border-radius:6px;opacity:0;transition:opacity .2s,color .2s,background .2s}
.recap-entry:hover .recap-delete-btn{opacity:1}
.recap-delete-btn:hover{color:var(--accent3);background:#ff6a6a15}

/* modal */
.modal-overlay{position:fixed;inset:0;background:#00000088;backdrop-filter:blur(6px);z-index:800;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .25s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--surface);border:1px solid #ffffff18;border-radius:24px;padding:28px 24px;width:100%;max-width:440px;transform:translateY(20px) scale(.97);transition:transform .3s cubic-bezier(.34,1.56,.64,1);box-shadow:0 32px 80px #00000080}
.modal-overlay.open .modal{transform:translateY(0) scale(1)}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:.1em;margin-bottom:6px}
.modal-subtitle{font-size:.8rem;color:var(--muted);margin-bottom:18px;line-height:1.4}
.modal textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.9rem;outline:none;resize:vertical;min-height:90px;line-height:1.5;transition:border-color .25s,box-shadow .25s;margin-bottom:16px}
.modal textarea::placeholder{color:var(--muted)}
.modal textarea:focus{border-color:var(--accent2);box-shadow:0 0 0 3px #7c6aff20}
.modal-btns{display:flex;gap:10px;justify-content:flex-end}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--muted);border-radius:12px;padding:10px 18px;font-family:'DM Sans',sans-serif;font-size:.85rem;cursor:pointer;transition:color .2s,border-color .2s}
.btn-ghost:hover{color:var(--text);border-color:#ffffff22}
.btn-primary{background:var(--accent2);color:#fff;border:none;border-radius:12px;padding:10px 22px;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:600;cursor:pointer;transition:opacity .2s,transform .2s}
.btn-primary:hover{opacity:.88;transform:translateY(-1px)}

/* utils */
.confetti{position:fixed;pointer-events:none;z-index:9999;border-radius:2px;animation:confettiFall 1.2s ease-out forwards}
@keyframes confettiFall{0%{transform:translateY(0) rotate(0deg) scale(1);opacity:1}100%{transform:translateY(200px) rotate(720deg) scale(0);opacity:0}}
.toast{position:fixed;bottom:calc(var(--nav-h) + 16px);left:50%;transform:translateX(-50%) translateY(20px);background:var(--accent);color:#0a0a0f;padding:11px 22px;border-radius:100px;font-weight:600;font-size:.86rem;letter-spacing:.02em;transition:transform .4s cubic-bezier(.34,1.56,.64,1),opacity .3s;opacity:0;pointer-events:none;z-index:9998}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}

/* responsive */
@media(max-width:640px){
  .page{padding:24px 16px calc(var(--nav-h) + 16px)}
  .logo{font-size:1.7rem}.date-badge{font-size:.65rem;padding:6px 10px}
  .stats-row{grid-template-columns:1fr 1fr;gap:10px;margin-bottom:22px}
  .stat-card:last-child{grid-column:span 2}.stat-card{padding:14px 16px;border-radius:16px}
  .stat-value{font-size:2.1rem}
  .add-form{gap:8px;margin-bottom:22px}
  .emoji-select{width:46px;padding:12px 8px}.habit-input{padding:12px 13px;font-size:.88rem}
  .add-btn{padding:12px 14px;font-size:.82rem}
  .habit-card{padding:13px}
  .card-actions{opacity:1}
  .week-dots{display:none}
  .nav-btn{padding:10px 24px;font-size:.65rem}
  .heatmap-cell{width:11px;height:11px}.month-label{width:11px;font-size:.58rem}
  .recap-compose-footer{flex-direction:column;align-items:flex-start}
}
@media(max-width:380px){
  .stats-row{grid-template-columns:1fr}.stat-card:last-child{grid-column:auto}
  .add-form{flex-wrap:wrap}.habit-input{flex:1 1 100%;order:-1}.add-btn{flex:1}
  .nav-btn{padding:10px 16px}
}
</style>
</head>
<body>
<div class="orb orb-1"></div>
<div class="orb orb-2"></div>

<!-- PAGE: HABITS -->
<div class="page active" id="page-habits">
  <header>
    <div class="logo">RITU<span>AL</span></div>
    <div class="date-badge" id="dateBadge"></div>
  </header>
  <div class="stats-row">
    <div class="stat-card"><div class="stat-label">Today</div><div class="stat-value accent" id="statProgress">0%</div><div class="stat-icon">üéØ</div></div>
    <div class="stat-card"><div class="stat-label">Best Streak</div><div class="stat-value" id="statBestStreak">0</div><div class="stat-icon">üî•</div></div>
    <div class="stat-card"><div class="stat-label">Habits</div><div class="stat-value accent2" id="statTotal">0</div><div class="stat-icon">‚ú®</div></div>
  </div>
  <div class="add-form">
    <div class="emoji-select" id="emojiPicker">üå±</div>
    <input class="habit-input" id="habitInput" type="text" placeholder="Add a new habit‚Ä¶" maxlength="50">
    <button class="add-btn" onclick="addHabit()">+ Add</button>
  </div>
  <div class="section-header">
    <div class="section-title">Today's Habits</div>
    <div style="font-family:'DM Mono',monospace;font-size:.75rem;color:var(--muted)" id="completedCount">0 / 0</div>
  </div>
  <div class="habits-list" id="habitsList"></div>
  <div class="heatmap-section">
    <div class="section-header"><div class="section-title">Activity</div></div>
    <div class="heatmap-wrapper">
      <div class="month-labels" id="monthLabels"></div>
      <div class="heatmap-grid" id="heatmapGrid"></div>
    </div>
  </div>
</div>

<!-- PAGE: RECAP -->
<div class="page" id="page-recap">
  <header>
    <div>
      <div class="logo">RE<span>CAP</span></div>
      <div style="font-family:'DM Mono',monospace;font-size:.7rem;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-top:3px">Daily reflections</div>
    </div>
    <div class="date-badge" id="recapDateBadge"></div>
  </header>
  <div class="recap-compose">
    <div class="recap-compose-title">How was your day?</div>
    <textarea class="recap-textarea" id="recapInput" placeholder="Write about what went well, what was tough, what you learned‚Ä¶ anything about your day." rows="4"></textarea>
    <div class="recap-compose-footer">
      <div class="mood-row">
        <button class="mood-btn" data-mood="üòä" onclick="selectMood(this)">üòä</button>
        <button class="mood-btn" data-mood="üòê" onclick="selectMood(this)">üòê</button>
        <button class="mood-btn" data-mood="üòî" onclick="selectMood(this)">üòî</button>
        <button class="mood-btn" data-mood="üî•" onclick="selectMood(this)">üî•</button>
        <button class="mood-btn" data-mood="üò¥" onclick="selectMood(this)">üò¥</button>
      </div>
      <button class="add-btn" onclick="addRecap()">Save Recap</button>
    </div>
  </div>
  <div class="section-header"><div class="section-title">Past Recaps</div></div>
  <div class="recap-entries" id="recapEntries"></div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-btn active" id="nav-habits" onclick="switchPage('habits')">
    <span class="nav-icon">‚úÖ</span>Habits
  </button>
  <button class="nav-btn" id="nav-recap" onclick="switchPage('recap')">
    <span class="nav-icon">üìì</span>Recap
  </button>
</nav>

<!-- TASK MODAL -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <div class="modal-title">Today's Task</div>
    <div class="modal-subtitle" id="modalSubtitle">Set a specific task ‚Äî resets at midnight.</div>
    <textarea id="taskInput" placeholder="e.g. Run 5km before breakfast, no stopping‚Ä¶"></textarea>
    <div class="modal-btns">
      <button class="btn-ghost" onclick="closeTaskModal()">Cancel</button>
      <button class="btn-primary" onclick="saveTask()">Save Task</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const EMOJIS=['üå±','üí™','üìö','üßò','üèÉ','üíß','üé®','üéµ','üß†','‚ö°','üåô','‚òÄÔ∏è','üçé','‚úçÔ∏è','üèãÔ∏è'];
let emojiIdx=0,selectedMood='',taskTargetId=null;

function getState(){const d={habits:[],log:{},tasks:{},recaps:[]};try{return JSON.parse(localStorage.getItem('ritual_v2')||JSON.stringify(d))}catch(e){return d}}
function saveState(s){localStorage.setItem('ritual_v2',JSON.stringify(s))}
function today(){return new Date().toISOString().slice(0,10)}
function dateStr(d){return d.toISOString().slice(0,10)}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

function switchPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
  if(name==='recap')renderRecap();
}

function setupListeners(){
  document.getElementById('emojiPicker').addEventListener('click',()=>{
    emojiIdx=(emojiIdx+1)%EMOJIS.length;
    document.getElementById('emojiPicker').textContent=EMOJIS[emojiIdx];
  });
  document.getElementById('habitInput').addEventListener('keydown',e=>{if(e.key==='Enter')addHabit()});
  document.getElementById('recapInput').addEventListener('keydown',e=>{if(e.key==='Enter'&&e.ctrlKey)addRecap()});
  document.getElementById('taskModal').addEventListener('click',e=>{if(e.target===document.getElementById('taskModal'))closeTaskModal()});
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeTaskModal()});
}

function addHabit(){
  const inp=document.getElementById('habitInput');
  const name=inp.value.trim();if(!name){inp.focus();return}
  const s=getState();
  s.habits.push({id:Date.now().toString(),name,emoji:EMOJIS[emojiIdx],createdAt:today()});
  saveState(s);inp.value='';render();
  showToast(EMOJIS[emojiIdx]+' "'+name+'" added!');
}

function toggleHabit(id){
  const s=getState(),t=today();
  if(!s.log[t])s.log[t]=[];
  const idx=s.log[t].indexOf(id);
  if(idx===-1){s.log[t].push(id);spawnConfetti();showToast('üéâ Habit completed!')}
  else s.log[t].splice(idx,1);
  saveState(s);render();
}

function deleteHabit(id){
  const s=getState();
  s.habits=s.habits.filter(h=>h.id!==id);
  for(const d in s.log)s.log[d]=s.log[d].filter(x=>x!==id);
  for(const d in s.tasks)if(s.tasks[d]&&s.tasks[d][id])delete s.tasks[d][id];
  saveState(s);render();showToast('Habit removed');
}

function getStreak(id){
  const s=getState();let streak=0;const d=new Date();
  if(!s.log[today()]?.includes(id))d.setDate(d.getDate()-1);
  for(let i=0;i<365;i++){const k=dateStr(d);if(s.log[k]?.includes(id)){streak++;d.setDate(d.getDate()-1)}else break}
  return streak;
}

function getWeekHistory(id){
  const s=getState(),d=new Date();
  return Array.from({length:7},(_,i)=>{const dd=new Date(d);dd.setDate(d.getDate()-(6-i));return s.log[dateStr(dd)]?.includes(id)?1:0});
}

function openTaskModal(id,name){
  taskTargetId=id;
  const s=getState();
  document.getElementById('modalSubtitle').textContent='Set a specific task for "'+name+'" ‚Äî resets at midnight.';
  document.getElementById('taskInput').value=s.tasks?.[today()]?.[id]||'';
  document.getElementById('taskModal').classList.add('open');
  setTimeout(()=>document.getElementById('taskInput').focus(),300);
}
function closeTaskModal(){document.getElementById('taskModal').classList.remove('open');taskTargetId=null}
function saveTask(){
  if(!taskTargetId)return;
  const text=document.getElementById('taskInput').value.trim();
  const s=getState(),t=today();
  if(!s.tasks)s.tasks={};if(!s.tasks[t])s.tasks[t]={};
  if(text)s.tasks[t][taskTargetId]=text;else delete s.tasks[t][taskTargetId];
  saveState(s);closeTaskModal();render();showToast(text?'üìù Task saved!':'Task cleared');
}

function render(){
  const s=getState(),t=today(),done=s.log[t]||[];
  document.getElementById('dateBadge').textContent=new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
  const total=s.habits.length;
  const doneCount=done.filter(id=>s.habits.find(h=>h.id===id)).length;
  const pct=total===0?0:Math.round(doneCount/total*100);
  document.getElementById('statProgress').textContent=pct+'%';
  document.getElementById('statTotal').textContent=total;
  document.getElementById('statBestStreak').textContent=s.habits.reduce((m,h)=>Math.max(m,getStreak(h.id)),0);
  document.getElementById('completedCount').textContent=doneCount+' / '+total+' done';
  const list=document.getElementById('habitsList');
  if(!s.habits.length){
    list.innerHTML='<div class="empty-state"><span class="icon">üå±</span>No habits yet. Start building your ritual!</div>';
  }else{
    list.innerHTML=s.habits.map(h=>{
      const isDone=done.includes(h.id),streak=getStreak(h.id),week=getWeekHistory(h.id),isHot=streak>=3,task=s.tasks?.[t]?.[h.id]||'';
      return `<div class="habit-card ${isDone?'completed':''}">
        <button class="check-btn ${isDone?'done':''}" onclick="toggleHabit('${h.id}')"><span class="checkmark">‚úì</span></button>
        <div class="habit-emoji">${h.emoji}</div>
        <div class="habit-info">
          <div class="habit-name">${esc(h.name)}</div>
          <div class="habit-meta">
            <div class="streak-badge ${isHot?'hot':''}"><span class="streak-flame">${isHot?'üî•':'üí§'}</span>${streak} day${streak!==1?'s':''}</div>
            <div class="week-dots">${week.map(v=>`<div class="dot ${v?'filled':''}"></div>`).join('')}</div>
          </div>
          ${task?`<div class="habit-task">üìù ${esc(task)}</div>`:''}
        </div>
        <div class="card-actions">
          <button class="icon-btn task-btn" onclick="openTaskModal('${h.id}','${esc(h.name)}')" title="Set today's task">üìù</button>
          <button class="icon-btn delete" onclick="deleteHabit('${h.id}')" title="Delete habit">‚úï</button>
        </div>
      </div>`;
    }).join('');
  }
  renderHeatmap();
}

function renderHeatmap(){
  const s=getState(),weeks=18,now=new Date(),start=new Date(now);
  start.setDate(start.getDate()-(weeks*7)+1);
  let cols='',lbls='',prev=-1;
  for(let w=0;w<weeks;w++){
    let col='';
    for(let d=0;d<7;d++){
      const dd=new Date(start);dd.setDate(start.getDate()+w*7+d);
      const key=dateStr(dd),total=s.habits.length;
      const dn=s.log[key]?.filter(id=>s.habits.find(h=>h.id===id)).length||0;
      const lv=total===0?0:Math.min(5,Math.ceil(dn/total*5));
      col+=`<div class="heatmap-cell" data-level="${lv}" title="${key}: ${dn}/${total}"></div>`;
    }
    cols+=`<div class="heatmap-col">${col}</div>`;
    const ws=new Date(start);ws.setDate(start.getDate()+w*7);
    if(ws.getMonth()!==prev){prev=ws.getMonth();lbls+=`<div class="month-label">${ws.toLocaleString('en',{month:'short'})}</div>`}
    else lbls+='<div class="month-label"></div>';
  }
  document.getElementById('heatmapGrid').innerHTML=cols;
  document.getElementById('monthLabels').innerHTML=lbls;
}

function selectMood(btn){
  document.querySelectorAll('.mood-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');selectedMood=btn.dataset.mood;
}

function addRecap(){
  const text=document.getElementById('recapInput').value.trim();
  if(!text){document.getElementById('recapInput').focus();return}
  const s=getState();if(!s.recaps)s.recaps=[];
  s.recaps.unshift({id:Date.now().toString(),date:today(),text,mood:selectedMood,ts:Date.now()});
  saveState(s);
  document.getElementById('recapInput').value='';
  selectedMood='';document.querySelectorAll('.mood-btn').forEach(b=>b.classList.remove('selected'));
  renderRecap();showToast('üìì Recap saved!');
}

function deleteRecap(id){
  const s=getState();s.recaps=s.recaps.filter(r=>r.id!==id);saveState(s);renderRecap();showToast('Recap removed');
}

function renderRecap(){
  document.getElementById('recapDateBadge').textContent=new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
  const s=getState(),entries=document.getElementById('recapEntries');
  if(!s.recaps||!s.recaps.length){
    entries.innerHTML='<div class="empty-state"><span class="icon">üìì</span>No recaps yet. Write your first reflection above!</div>';return;
  }
  entries.innerHTML=s.recaps.map(r=>{
    const label=new Date(r.date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
    return `<div class="recap-entry">
      <div class="recap-entry-header">
        <div class="recap-entry-date">${label}</div>
        ${r.mood?`<div class="recap-entry-mood">${r.mood}</div>`:''}
      </div>
      <div class="recap-entry-text">${esc(r.text)}</div>
      <button class="recap-delete-btn" onclick="deleteRecap('${r.id}')">‚úï</button>
    </div>`;
  }).join('');
}

function spawnConfetti(){
  const colors=['#c8fa64','#7c6aff','#ff6a6a','#ffd93d','#fff'];
  for(let i=0;i<18;i++){
    const el=document.createElement('div');el.className='confetti';
    el.style.cssText=`left:${30+Math.random()*40}vw;top:${20+Math.random()*30}vh;width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;background:${colors[Math.floor(Math.random()*colors.length)]};animation-delay:${Math.random()*.4}s;animation-duration:${.9+Math.random()*.6}s;`;
    document.body.appendChild(el);el.addEventListener('animationend',()=>el.remove());
  }
}

let toastTimer;
function showToast(msg){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),2200);
}

document.addEventListener('DOMContentLoaded',()=>{setupListeners();render()});
</script>
</body>
</html>